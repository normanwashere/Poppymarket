<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="manifest" href="/manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA Seller/Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <!-- Supabase JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Custom Styles */
        body {
            font-family: 'Inter', sans-serif;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.45);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 1.25rem; /* 20px */
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }
        .hidden {
            display: none;
        }
        .filter-btn.active {
            background-color: #ec4899; /* pink-500 */
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 14px 0 rgb(236 72 153 / 39%);
        }

        /* --- Responsive Table/Card List Styling --- */
        .logs-table thead, .users-table thead { display: none; }
        .logs-table tr, .users-table tr {
            display: block;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .logs-table td, .users-table td {
            display: block;
            padding: 0;
            text-align: left;
            border-bottom: none;
        }
        .logs-table td::before, .users-table td::before { display: none; }

        @media (min-width: 1024px) {
            .logs-table thead, .users-table thead { display: table-header-group; }
            .logs-table tr, .users-table tr {
                display: table-row;
                background: transparent;
                box-shadow: none;
                margin-bottom: 0;
                padding: 0;
                border-radius: 0;
                border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            }
             .logs-table tbody tr:last-child, .users-table tbody tr:last-child { border-bottom: none; }
            .logs-table td, .users-table td {
                display: table-cell;
                padding: 0.75rem;
            }
        }
        
        /* --- Notification Toast --- */
        #notification-toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(200%);
            transition: transform 0.5s ease-in-out;
            z-index: 100;
        }
        #notification-toast.show {
            transform: translateX(-50%) translateY(0);
        }

        /* --- Skeleton Loader --- */
        .skeleton {
            background-color: rgba(255, 255, 255, 0.55);
            position: relative;
            overflow: hidden;
        }
        .skeleton::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            transform: translateX(-100%);
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            100% {
                transform: translateX(100%);
            }
        }
        
        /* --- Stat Card Skeleton --- */
        .stat-skeleton .stat-value {
            background-color: rgba(255, 255, 255, 0.6);
            border-radius: 0.5rem;
            min-height: 28px; /* Or match your text height */
            width: 60%;
            margin: 0 auto;
            position: relative;
            overflow: hidden;
        }
        .stat-skeleton .stat-value::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            transform: translateX(-100%);
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.5), transparent);
            animation: shimmer 1.5s infinite;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-pink-200 via-rose-100 to-stone-200 min-h-screen w-full">

    <main id="app-container" class="p-4 max-w-6xl mx-auto">
        <!-- Login Screen -->
        <div id="login-screen" class="w-full max-w-md text-center mx-auto mt-[20vh]">
            <div class="glass-card p-8">
                <h1 class="text-4xl font-bold text-gray-800 mb-2">Poppy Market</h1>
                <p class="text-gray-600 mb-8">Sign in to continue</p>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="email" class="sr-only">Email</label>
                        <input type="email" id="email" placeholder="Email Address" required class="w-full p-3 rounded-lg border-white/40 bg-white/50 focus:ring-pink-500 focus:border-pink-500 transition-colors" />
                    </div>
                    <div>
                        <label for="password" class="sr-only">Password</label>
                        <input type="password" id="password" placeholder="Password" required class="w-full p-3 rounded-lg border-white/40 bg-white/50 focus:ring-pink-500 focus:border-pink-500 transition-colors" />
                    </div>
                    <button type="submit" class="w-full flex items-center justify-center gap-3 bg-pink-500 text-white font-bold py-3 px-4 rounded-xl hover:bg-pink-600 transition-all duration-300 transform hover:scale-105 shadow-md">
                        <span>Sign In</span>
                    </button>
                </form>
                <p class="text-sm text-gray-600 mt-6">
                    Don't have an account? <a href="#" id="show-register-link" class="font-bold text-pink-500 hover:underline">Register</a>
                </p>
            </div>
        </div>
        
        <!-- Registration Screen -->
        <div id="register-screen" class="hidden w-full max-w-md text-center mx-auto mt-[15vh]">
            <div class="glass-card p-8">
                <h1 class="text-4xl font-bold text-gray-800 mb-2">Create Account</h1>
                <p class="text-gray-600 mb-8">Join the Poppy Market team.</p>
                <form id="register-form" class="space-y-4">
                    <div>
                        <label for="register-full-name" class="sr-only">Full Name</label>
                        <input type="text" id="register-full-name" placeholder="Full Name" required class="w-full p-3 rounded-lg border-white/40 bg-white/50 focus:ring-pink-500 focus:border-pink-500 transition-colors" />
                    </div>
                    <div>
                        <label for="register-email" class="sr-only">Email</label>
                        <input type="email" id="register-email" placeholder="Email Address" required class="w-full p-3 rounded-lg border-white/40 bg-white/50 focus:ring-pink-500 focus:border-pink-500 transition-colors" />
                    </div>
                    <div>
                        <label for="register-password" class="sr-only">Password</label>
                        <input type="password" id="register-password" placeholder="Password" required class="w-full p-3 rounded-lg border-white/40 bg-white/50 focus:ring-pink-500 focus:border-pink-500 transition-colors" />
                    </div>
                    <button type="submit" class="w-full flex items-center justify-center gap-3 bg-pink-500 text-white font-bold py-3 px-4 rounded-xl hover:bg-pink-600 transition-all duration-300 transform hover:scale-105 shadow-md">
                        <span>Register</span>
                    </button>
                </form>
                <p class="text-sm text-gray-600 mt-6">
                    Already have an account? <a href="#" id="show-login-link" class="font-bold text-pink-500 hover:underline">Sign In</a>
                </p>
            </div>
        </div>

        <!-- Email Verified Screen -->
        <div id="verified-screen" class="hidden w-full max-w-md text-center mx-auto mt-[20vh]">
            <div class="glass-card p-8">
                <h1 class="text-4xl font-bold text-gray-800 mb-2">Email Verified!</h1>
                <p class="text-gray-600 mb-8">Thank you for confirming your email. You can now sign in to your account.</p>
                <button id="go-to-login-btn" class="w-full flex items-center justify-center gap-3 bg-pink-500 text-white font-bold py-3 px-4 rounded-xl hover:bg-pink-600 transition-all duration-300 transform hover:scale-105 shadow-md">
                    <span>Go to Login</span>
                </button>
            </div>
        </div>
        
        <!-- Password Reset Screen -->
        <div id="password-reset-screen" class="hidden w-full max-w-md text-center mx-auto mt-[20vh]">
            <div class="glass-card p-8">
                <h1 class="text-4xl font-bold text-gray-800 mb-2">Reset Password</h1>
                <p class="text-gray-600 mb-8">Enter your new password below.</p>
                <form id="password-reset-form" class="space-y-4">
                    <div>
                        <label for="new-password" class="sr-only">New Password</label>
                        <input type="password" id="new-password" placeholder="New Password" required class="w-full p-3 rounded-lg border-white/40 bg-white/50 focus:ring-pink-500 focus:border-pink-500 transition-colors" />
                    </div>
                     <div>
                        <label for="confirm-new-password" class="sr-only">Confirm New Password</label>
                        <input type="password" id="confirm-new-password" placeholder="Confirm New Password" required class="w-full p-3 rounded-lg border-white/40 bg-white/50 focus:ring-pink-500 focus:border-pink-500 transition-colors" />
                    </div>
                    <button type="submit" class="w-full flex items-center justify-center gap-3 bg-pink-500 text-white font-bold py-3 px-4 rounded-xl hover:bg-pink-600 transition-all duration-300 transform hover:scale-105 shadow-md">
                        <span>Save New Password</span>
                    </button>
                </form>
            </div>
        </div>

        <!-- Seller Dashboard -->
        <div id="seller-dashboard" class="hidden w-full">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-3xl font-bold text-gray-800">Dashboard</h1>
                <div class="flex items-center gap-4">
                     <p id="seller-welcome-name" class="text-gray-700 font-medium hidden sm:block"></p>
                    <button id="open-profile-modal-btn" class="flex items-center justify-center bg-white/50 text-gray-600 w-10 h-10 rounded-full hover:bg-white/80 transition-all" title="My Profile">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                    </button>
                    <button class="logout-btn flex items-center gap-2 text-gray-600 hover:text-pink-500 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                        <span>Logout</span>
                    </button>
                </div>
            </div>
            
            <div class="glass-card p-4 mb-4">
                <div class="flex flex-col">
                    <div class="flex items-center gap-4">
                        <div class="grid grid-cols-3 gap-2 flex-grow" id="date-filter-buttons">
                            <button data-filter="this-week" class="filter-btn w-full px-3 py-2 text-sm rounded-lg bg-white/50 hover:bg-white/80 transition-shadow">This Week</button>
                            <button data-filter="last-week" class="filter-btn w-full px-3 py-2 text-sm rounded-lg bg-white/50 hover:bg-white/80 transition-shadow">Last Week</button>
                            <button data-filter="custom" class="filter-btn w-full px-3 py-2 text-sm rounded-lg bg-white/50 hover:bg-white/80 transition-shadow">Custom</button>
                        </div>
                        <button id="open-log-entry-modal" class="flex-shrink-0 flex items-center justify-center bg-pink-500 text-white w-10 h-10 rounded-full hover:bg-pink-600 transition-all duration-300 transform hover:scale-110 shadow-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14m-7-7h14"/></svg>
                        </button>
                    </div>
                    <div id="custom-date-filter" class="hidden flex flex-col sm:flex-row items-center gap-4 mt-4">
                         <div class="w-full sm:w-auto flex-1">
                            <label for="start-date-input" class="text-xs text-gray-600">Start Date:</label>
                            <input type="date" id="start-date-input" class="w-full p-2 text-sm rounded-lg border-white/40 bg-white/50 focus:ring-pink-500 focus:border-pink-500">
                        </div>
                        <div class="w-full sm:w-auto flex-1">
                            <label for="end-date-input" class="text-xs text-gray-600">End Date:</label>
                            <input type="date" id="end-date-input" class="w-full p-2 text-sm rounded-lg border-white/40 bg-white/50 focus:ring-pink-500 focus:border-pink-500">
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">
                <!-- Stat Cards -->
                <div class="glass-card text-center p-2"><div class="flex items-center justify-center gap-1.5"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-pink-600"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg><p class="text-gray-600 text-xs font-medium">Branded</p></div><p id="stat-branded" class="text-2xl font-bold text-gray-800">0</p></div>
                <div class="glass-card text-center p-2"><div class="flex items-center justify-center gap-1.5"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-teal-600"><path d="M20.38 3.46 16 2a4 4 0 0 0-8 0L3.62 3.46a2 2 0 0 0-1.34 2.23l.58 3.47a1 1 0 0 0 .99 .84H6v10c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V10h2.15a1 1 0 0 0 .99-.84l.58-3.47a2 2 0 0 0-1.34-2.23z"/></svg><p class="text-gray-600 text-xs font-medium">Free Size</p></div><p id="stat-freesize" class="text-2xl font-bold text-gray-800">0</p></div>
                <div class="glass-card text-center p-2"><div class="flex items-center justify-center gap-1.5"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4h-4z"/></svg><p class="text-gray-600 text-xs font-medium">Base Pay</p></div><p id="stat-basepay" class="text-xl font-bold text-gray-800">₱0</p></div>
                
                <!-- Bonus Cards -->
                <div class="glass-card text-center p-2 bg-amber-100/60">
                    <div class="relative group flex items-center justify-center gap-1.5">
                        <p class="text-amber-800 text-xs font-medium">Daily Bonus</p>
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-amber-600"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                        <div id="daily-bonus-tooltip" class="absolute bottom-full mb-2 w-48 p-2 text-xs text-left text-white bg-gray-800 rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-10">
                            Loading...
                            <svg class="absolute text-gray-800 h-2 w-full left-0 top-full" x="0px" y="0px" viewBox="0 0 255 255" xml:space="preserve"><polygon class="fill-current" points="0,0 127.5,127.5 255,0"/></svg>
                        </div>
                    </div>
                    <p id="stat-daily-bonus" class="text-xl font-bold text-amber-900">₱0</p>
                </div>
                <div class="glass-card text-center p-2 bg-amber-100/60">
                    <div class="relative group flex items-center justify-center gap-1.5">
                        <p class="text-amber-800 text-xs font-medium">Weekly Bonus</p>
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-amber-600"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                        <div id="weekly-bonus-tooltip" class="absolute bottom-full mb-2 w-48 p-2 text-xs text-left text-white bg-gray-800 rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-10">
                            Loading...
                            <svg class="absolute text-gray-800 h-2 w-full left-0 top-full" x="0px" y="0px" viewBox="0 0 255 255" xml:space="preserve"><polygon class="fill-current" points="0,0 127.5,127.5 255,0"/></svg>
                        </div>
                    </div>
                    <p id="stat-weekly-bonus" class="text-xl font-bold text-amber-900">₱0</p>
                </div>
                <div class="glass-card text-center p-2 bg-amber-100/60">
                     <div class="relative group flex items-center justify-center gap-1.5">
                        <p class="text-amber-800 text-xs font-medium">Monthly Bonus</p>
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-amber-600"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                        <div id="monthly-bonus-tooltip" class="absolute bottom-full mb-2 w-48 p-2 text-xs text-left text-white bg-gray-800 rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-10">
                           Loading...
                            <svg class="absolute text-gray-800 h-2 w-full left-0 top-full" x="0px" y="0px" viewBox="0 0 255 255" xml:space="preserve"><polygon class="fill-current" points="0,0 127.5,127.5 255,0"/></svg>
                        </div>
                    </div>
                    <p id="stat-monthly-bonus" class="text-xl font-bold text-amber-900">₱0</p>
                </div>
                <div class="glass-card text-center p-2 col-span-2 bg-purple-200/60">
                    <div class="flex items-center justify-center gap-1.5">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-800"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="m9 12 2 2 4-4"/></svg>
                        <p class="text-purple-800 text-xs font-medium">Total Payout</p>
                    </div>
                    <p id="stat-total" class="text-xl font-bold text-purple-900">₱0</p>
                </div>
            </div>

            <div class="glass-card">
                <h2 class="text-xl font-bold text-gray-700 mb-4 px-4 pt-4 lg:px-6 lg:pt-6">Previous Logs</h2>
                <div class="w-full">
                    <table class="logs-table w-full text-left">
                        <thead>
                            <tr>
                                <th class="p-3 font-semibold text-gray-700 text-sm">Date & Duration</th>
                                <th class="p-3 font-semibold text-gray-700 text-sm">Items Sold</th>
                                <th class="p-3 font-semibold text-gray-700 text-sm">Payout Details</th>
                            </tr>
                        </thead>
                        <tbody id="previous-logs-table">
                            <!-- JS will populate this -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Admin Dashboard -->
        <div id="admin-dashboard" class="hidden w-full">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-3xl font-bold text-gray-800">Admin</h1>
                <button class="logout-btn flex items-center gap-2 text-gray-600 hover:text-pink-500 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                    <span>Logout</span>
                </button>
            </div>
            
            <div class="glass-card p-4 mb-4">
                <div class="flex flex-col gap-4">
                    <div class="grid grid-cols-3 gap-2 flex-grow w-full" id="admin-date-filter-buttons">
                        <button data-filter="this-week" class="filter-btn w-full px-3 py-2 text-sm rounded-lg bg-white/50 hover:bg-white/80 transition-shadow">This Week</button>
                        <button data-filter="last-week" class="filter-btn w-full px-3 py-2 text-sm rounded-lg bg-white/50 hover:bg-white/80 transition-shadow">Last Week</button>
                        <button data-filter="custom" class="filter-btn w-full px-3 py-2 text-sm rounded-lg bg-white/50 hover:bg-white/80 transition-shadow">Custom</button>
                    </div>
                     <div id="admin-custom-date-filter" class="hidden flex flex-col sm:flex-row items-center gap-4">
                         <div class="w-full sm:w-auto flex-1">
                            <label for="admin-start-date-input" class="text-xs text-gray-600">Start Date:</label>
                            <input type="date" id="admin-start-date-input" class="w-full p-2 text-sm rounded-lg border-white/40 bg-white/50 focus:ring-pink-500 focus:border-pink-500">
                        </div>
                        <div class="w-full sm:w-auto flex-1">
                            <label for="admin-end-date-input" class="text-xs text-gray-600">End Date:</label>
                            <input type="date" id="admin-end-date-input" class="w-full p-2 text-sm rounded-lg border-white/40 bg-white/50 focus:ring-pink-500 focus:border-pink-500">
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="w-full flex-grow">
                            <label for="seller-filter" class="sr-only">Select Seller</label>
                            <select id="seller-filter" class="w-full p-2 text-sm rounded-lg border-white/40 bg-white/50 focus:ring-pink-500 focus:border-pink-500">
                                <!-- Options populated by JS -->
                            </select>
                        </div>
                        <button id="open-bonus-config-modal" class="flex-shrink-0 flex items-center justify-center bg-blue-500 text-white w-10 h-10 rounded-full hover:bg-blue-600 transition-all duration-300 transform hover:scale-110 shadow-lg" title="Bonus Configuration">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-4.44a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8.38"/><path d="M16 2l5 5h-5V2z"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/></svg>
                        </button>
                        <button id="open-user-management-btn" class="flex-shrink-0 flex items-center justify-center bg-gray-700 text-white w-10 h-10 rounded-full hover:bg-gray-800 transition-all duration-300 transform hover:scale-110 shadow-lg" title="Manage Users">
                           <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">
                <!-- Admin Stat Cards -->
                <div class="glass-card text-center p-2"><div class="flex items-center justify-center gap-1.5"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-pink-600"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg><p class="text-gray-600 text-xs font-medium">Branded</p></div><p id="admin-stat-branded" class="text-2xl font-bold text-gray-800">0</p></div>
                <div class="glass-card text-center p-2"><div class="flex items-center justify-center gap-1.5"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-teal-600"><path d="M20.38 3.46 16 2a4 4 0 0 0-8 0L3.62 3.46a2 2 0 0 0-1.34 2.23l.58 3.47a1 1 0 0 0 .99 .84H6v10c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V10h2.15a1 1 0 0 0 .99-.84l.58-3.47a2 2 0 0 0-1.34-2.23z"/></svg><p class="text-gray-600 text-xs font-medium">Free Size</p></div><p id="admin-stat-freesize" class="text-2xl font-bold text-gray-800">0</p></div>
                <div class="glass-card text-center p-2"><div class="flex items-center justify-center gap-1.5"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4h-4z"/></svg><p class="text-gray-600 text-xs font-medium">Base Pay</p></div><p id="admin-stat-basepay" class="text-xl font-bold text-gray-800">₱0</p></div>
                <div class="glass-card text-center p-2 bg-amber-100/60"><div class="relative group flex items-center justify-center gap-1.5"><p class="text-amber-800 text-xs font-medium">Daily Bonus</p></div><p id="admin-stat-daily-bonus" class="text-xl font-bold text-amber-900">₱0</p></div>
                <div class="glass-card text-center p-2 bg-amber-100/60"><div class="relative group flex items-center justify-center gap-1.5"><p class="text-amber-800 text-xs font-medium">Weekly Bonus</p></div><p id="admin-stat-weekly-bonus" class="text-xl font-bold text-amber-900">₱0</p></div>
                <div class="glass-card text-center p-2 bg-amber-100/60"><div class="relative group flex items-center justify-center gap-1.5"><p class="text-amber-800 text-xs font-medium">Monthly Bonus</p></div><p id="admin-stat-monthly-bonus" class="text-xl font-bold text-amber-900">₱0</p></div>
                <div class="glass-card text-center p-2 col-span-2 bg-purple-200/60"><div class="flex items-center justify-center gap-1.5"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-800"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="m9 12 2 2 4-4"/></svg><p class="text-purple-800 text-xs font-medium">Total Payout</p></div><p id="admin-stat-total" class="text-xl font-bold text-purple-900">₱0</p></div>
            </div>

            <div class="glass-card">
                <h2 class="text-xl font-bold text-gray-700 mb-4 px-4 pt-4 lg:px-6 lg:pt-6">Seller Logs</h2>
                <div class="w-full">
                    <table class="logs-table w-full text-left">
                        <thead>
                            <tr>
                                <th class="p-3 font-semibold text-gray-700 text-sm">Date & Duration</th>
                                <th class="p-3 font-semibold text-gray-700 text-sm">Items Sold</th>
                                <th class="p-3 font-semibold text-gray-700 text-sm">Payout Details</th>
                                <th class="p-3 font-semibold text-gray-700 text-sm">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="admin-logs-table">
                            <!-- JS will populate this -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- User Management Page -->
        <div id="user-management-page" class="hidden w-full">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-3xl font-bold text-gray-800">Users</h1>
                <button id="back-to-admin-dash-btn" class="flex items-center gap-2 text-gray-600 hover:text-pink-500 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                    <span>Back</span>
                </button>
            </div>
            <div class="glass-card p-4">
                 <div class="flex justify-end mb-4">
                    <button id="add-new-user-btn" class="flex items-center gap-2 bg-pink-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-pink-600 transition-all shadow">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="17" y1="11" x2="23" y2="11"/></svg>
                        <span>Add New User</span>
                    </button>
                </div>
                <table class="users-table w-full text-left">
                    <thead>
                        <tr>
                            <th class="p-3 font-semibold text-gray-700 text-sm">Name</th>
                            <th class="p-3 font-semibold text-gray-700 text-sm">Role</th>
                            <th class="p-3 font-semibold text-gray-700 text-sm">Status</th>
                            <th class="p-3 font-semibold text-gray-700 text-sm">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="user-list-table">
                        <!-- User list populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Modals -->
        <!-- Log Entry/Edit Modal -->
        <div id="log-entry-modal" class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 p-4">
             <div class="glass-card w-full max-w-lg relative p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="log-modal-title" class="text-2xl font-bold text-gray-700">Log Entry</h2>
                    <button id="close-log-entry-modal" class="text-gray-500 hover:text-gray-800 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                <div id="log-modal-seller-name" class="hidden text-sm font-medium text-gray-600 mb-4"></div>
                <form id="log-entry-form" class="space-y-4">
                    <input type="hidden" id="log-id" />
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Start</label>
                            <input id="start-time" type="datetime-local" class="w-full p-2 rounded-lg border-white/40 bg-white/50 focus:ring-pink-500 focus:border-pink-500" required />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">End</label>
                            <input id="end-time" type="datetime-local" class="w-full p-2 rounded-lg border-white/40 bg-white/50 focus:ring-pink-500 focus:border-pink-500" required />
                        </div>
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">Duration</label>
                        <input id="duration" type="text" value="0h 0m" class="w-full p-2 rounded-lg border-white/40 bg-gray-200/50 cursor-not-allowed text-gray-500" readonly />
                    </div>
                     <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Branded Sold</label>
                            <input id="branded-sold" type="number" placeholder="0" min="0" class="w-full p-2 rounded-lg border-white/40 bg-white/50 focus:ring-pink-500 focus:border-pink-500" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Free Size Sold</label>
                            <input id="free-size-sold" type="number" placeholder="0" min="0" class="w-full p-2 rounded-lg border-white/40 bg-white/50 focus:ring-pink-500 focus:border-pink-500" />
                        </div>
                    </div>
                    <!-- REMOVED: Base Pay input is no longer needed from the client -->
                    <button type="submit" class="w-full bg-pink-500 text-white font-bold py-3 px-4 rounded-xl hover:bg-pink-600 transition-all duration-300 transform hover:scale-105 shadow-md mt-6">
                        Submit Log
                    </button>
                </form>
            </div>
        </div>

        <!-- Bonus Configuration Modal -->
        <div id="bonus-config-modal" class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 p-4">
             <div class="glass-card w-full max-w-lg relative p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-700">Bonus Configuration</h2>
                    <button id="close-bonus-config-modal" class="text-gray-500 hover:text-gray-800 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                <form id="bonus-config-form" class="space-y-4">
                    <input type="hidden" id="bonus-config-id" />
                    <div>
                        <label for="bonus-type-select" class="block text-sm font-medium text-gray-600 mb-1">Bonus Type</label>
                        <select id="bonus-type-select" class="w-full p-2 rounded-lg border-white/40 bg-white/50 focus:ring-pink-500 focus:border-pink-500">
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                        </select>
                    </div>
                    <p class="text-sm font-medium text-gray-600 pt-2">Targets</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Min Duration (hours)</label>
                            <input id="target-duration" type="number" placeholder="e.g., 8" min="0" class="w-full p-2 rounded-lg border-white/40 bg-white/50 focus:ring-pink-500 focus:border-pink-500" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Min Branded Sold</label>
                            <input id="target-branded" type="number" placeholder="e.g., 5" min="0" class="w-full p-2 rounded-lg border-white/40 bg-white/50 focus:ring-pink-500 focus:border-pink-500" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Min Free Size Sold</label>
                            <input id="target-freesize" type="number" placeholder="e.g., 10" min="0" class="w-full p-2 rounded-lg border-white/40 bg-white/50 focus:ring-pink-500 focus:border-pink-500" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Bonus Amount (₱)</label>
                            <input id="bonus-amount" type="number" placeholder="e.g., 150" min="0" class="w-full p-2 rounded-lg border-white/40 bg-white/50 focus:ring-pink-500 focus:border-pink-500" />
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-xl hover:bg-blue-600 transition-all duration-300 transform hover:scale-105 shadow-md mt-6">
                        Save Configuration
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Add/Edit User Modal -->
        <div id="user-modal" class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 p-4">
             <div class="glass-card w-full max-w-md relative p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="user-modal-title" class="text-2xl font-bold text-gray-700">Add User</h2>
                    <button id="close-user-modal" class="text-gray-500 hover:text-gray-800 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                <form id="user-form" class="space-y-4">
                    <input type="hidden" id="user-id" />
                     <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">Email</label>
                        <input id="user-email" type="email" class="w-full p-2 rounded-lg border-white/40 bg-white/50 focus:ring-pink-500 focus:border-pink-500" required />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">Full Name</label>
                        <input id="user-name" type="text" class="w-full p-2 rounded-lg border-white/40 bg-white/50 focus:ring-pink-500 focus:border-pink-500" required />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">Role</label>
                        <select id="user-role" class="w-full p-2 rounded-lg border-white/40 bg-white/50 focus:ring-pink-500 focus:border-pink-500">
                            <option value="seller">Seller</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">Status</label>
                        <select id="user-status" class="w-full p-2 rounded-lg border-white/40 bg-white/50 focus:ring-pink-500 focus:border-pink-500">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="pending">Pending</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full bg-pink-500 text-white font-bold py-3 px-4 rounded-xl hover:bg-pink-600 transition-all duration-300 transform hover:scale-105 shadow-md mt-6">
                        Save User
                    </button>
                    <button type="button" id="reset-password-btn" class="hidden w-full bg-gray-500 text-white font-bold py-3 px-4 rounded-xl hover:bg-gray-600 transition-all">
                        Send Password Reset
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Seller Profile Modal -->
        <div id="profile-modal" class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 p-4">
             <div class="glass-card w-full max-w-md relative p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-700">My Profile</h2>
                    <button id="close-profile-modal" class="text-gray-500 hover:text-gray-800 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                <form id="profile-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">Full Name</label>
                        <input id="profile-name" type="text" class="w-full p-2 rounded-lg border-white/40 bg-white/50 focus:ring-pink-500 focus:border-pink-500" />
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">Phone Number</label>
                        <input id="profile-phone" type="tel" class="w-full p-2 rounded-lg border-white/40 bg-white/50 focus:ring-pink-500 focus:border-pink-500" />
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">Gcash Number</label>
                        <input id="profile-gcash" type="tel" class="w-full p-2 rounded-lg border-white/40 bg-white/50 focus:ring-pink-500 focus:border-pink-500" />
                    </div>
                    
                    <div class="pt-4 border-t border-white/30">
                        <p class="text-sm font-medium text-gray-800">Change Password</p>
                        <div class="mt-2 space-y-4">
                             <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">New Password</label>
                                <input id="profile-new-password" type="password" class="w-full p-2 rounded-lg border-white/40 bg-white/50 focus:ring-pink-500 focus:border-pink-500" />
                            </div>
                             <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">Confirm New Password</label>
                                <input id="profile-confirm-password" type="password" class="w-full p-2 rounded-lg border-white/40 bg-white/50 focus:ring-pink-500 focus:border-pink-500" />
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="w-full bg-pink-500 text-white font-bold py-3 px-4 rounded-xl hover:bg-pink-600 transition-all duration-300 transform hover:scale-105 shadow-md mt-6">
                        Save Changes
                    </button>
                </form>
            </div>
        </div>
    </main>
    
    <!-- Notification Toast -->
    <div id="notification-toast" class="p-4 rounded-lg shadow-lg text-white">
        <p id="notification-message"></p>
    </div>


    <script>
        // --- Supabase Client Setup ---
        const SUPABASE_URL = 'https://lmzxjxumfqjrvcnsrfbr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxtenhqeHVtZnFqcnZjbnNyZmJyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA1MDUzNDIsImV4cCI6MjA2NjA4MTM0Mn0.7vd1mZzXKYjf64b_lRmPUR0KM_4VdgJMxsDVrCEYbTw';
        
        // --- App State ---
        let supabaseClient;
        let currentUserProfile = null;
        let bonusConfigs = {};

        document.addEventListener('DOMContentLoaded', () => {
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            // --- REMOVE SERVICE WORKER REGISTRATION ---
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(function(registrations) {
                    for(let registration of registrations) {
                        registration.unregister();
                    }
                });
            }

            // --- DOM Elements ---
            const loginScreen = document.getElementById('login-screen');
            const registerScreen = document.getElementById('register-screen');
            const passwordResetScreen = document.getElementById('password-reset-screen');
            const verifiedScreen = document.getElementById('verified-screen');
            const sellerDashboard = document.getElementById('seller-dashboard');
            const adminDashboard = document.getElementById('admin-dashboard');
            const userManagementPage = document.getElementById('user-management-page');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const passwordResetForm = document.getElementById('password-reset-form');
            const logoutBtns = document.querySelectorAll('.logout-btn');
            const showRegisterLink = document.getElementById('show-register-link');
            const showLoginLink = document.getElementById('show-login-link');
            const goToLoginBtn = document.getElementById('go-to-login-btn');
            
            // Seller UI
            const openLogEntryModalBtn = document.getElementById('open-log-entry-modal');
            const dateFilterButtons = document.getElementById('date-filter-buttons');
            const customDateFilter = document.getElementById('custom-date-filter');
            const startDateInput = document.getElementById('start-date-input');
            const endDateInput = document.getElementById('end-date-input');
            const logsTableBody = document.getElementById('previous-logs-table');
            const openProfileModalBtn = document.getElementById('open-profile-modal-btn');
            const sellerWelcomeName = document.getElementById('seller-welcome-name');

            // Admin UI
            const sellerFilter = document.getElementById('seller-filter');
            const adminDateFilterButtons = document.getElementById('admin-date-filter-buttons');
            const adminCustomDateFilter = document.getElementById('admin-custom-date-filter');
            const adminStartDateInput = document.getElementById('admin-start-date-input');
            const adminEndDateInput = document.getElementById('admin-end-date-input');
            const adminLogsTableBody = document.getElementById('admin-logs-table');
            const openBonusConfigModalBtn = document.getElementById('open-bonus-config-modal');
            const openUserManagementBtn = document.getElementById('open-user-management-btn');
            const backToAdminDashBtn = document.getElementById('back-to-admin-dash-btn');
            const userListTable = document.getElementById('user-list-table');
            const addNewUserBtn = document.getElementById('add-new-user-btn');

            // Modals
            const logEntryModal = document.getElementById('log-entry-modal');
            const closeLogEntryModalBtn = document.getElementById('close-log-entry-modal');
            const logEntryForm = document.getElementById('log-entry-form');
            const logModalTitle = document.getElementById('log-modal-title');
            const logModalSellerName = document.getElementById('log-modal-seller-name');
            const bonusConfigModal = document.getElementById('bonus-config-modal');
            const closeBonusConfigModalBtn = document.getElementById('close-bonus-config-modal');
            const bonusConfigForm = document.getElementById('bonus-config-form');
            const bonusTypeSelect = document.getElementById('bonus-type-select');
            const userModal = document.getElementById('user-modal');
            const userModalTitle = document.getElementById('user-modal-title');
            const closeUserModalBtn = document.getElementById('close-user-modal');
            const userForm = document.getElementById('user-form');
            const resetPasswordBtn = document.getElementById('reset-password-btn');
            const profileModal = document.getElementById('profile-modal');
            const closeProfileModalBtn = document.getElementById('close-profile-modal');
            const profileForm = document.getElementById('profile-form');

            // --- Helper Functions ---
            function showNotification(message, isError = false) {
                const toast = document.getElementById('notification-toast');
                const messageEl = document.getElementById('notification-message');
                if(!toast || !messageEl) return;

                messageEl.textContent = message;
                toast.className = `p-4 rounded-lg shadow-lg text-white ${isError ? 'bg-red-500' : 'bg-green-500'}`;
                toast.classList.add('show');

                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }
            
            function hideAllScreens() {
                loginScreen.classList.add('hidden');
                registerScreen.classList.add('hidden');
                passwordResetScreen.classList.add('hidden');
                verifiedScreen.classList.add('hidden');
                sellerDashboard.classList.add('hidden');
                adminDashboard.classList.add('hidden');
                userManagementPage.classList.add('hidden');
            }

            async function fetchUserProfile(user) {
                const { data, error } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', user.id)
                    .single();
                
                if (error) {
                    console.warn("Could not fetch profile on attempt. Error:", error.message);
                    return null;
                }
                return data;
            }

            async function handleUserSession(session) {
                if (!session || !session.user) {
                    hideAllScreens();
                    const hash = window.location.hash;
                    if (hash.includes('type=signup')) {
                        verifiedScreen.classList.remove('hidden');
                    } else {
                        loginScreen.classList.remove('hidden');
                    }
                    return;
                }

                let profile = null;
                let lastProfileError = null;
                for (let i = 0; i < 5; i++) {
                    profile = await fetchUserProfile(session.user);
                    if (profile) break;
                    lastProfileError = `Attempt ${i+1}: Could not fetch profile.`;
                    await new Promise(res => setTimeout(res, 500));
                }

                if (!profile) {
                    console.error("Login loop debug: Failed to load profile after 5 attempts.", lastProfileError, session?.user);
                    showNotification("Could not load your profile. Please try logging in again. (Profile missing)", true);
                    await supabaseClient.auth.signOut();
                    return;
                }

                if (profile.status !== 'active') {
                    console.error("Login loop debug: Profile status is not 'active'.", profile);
                    showNotification(`Your account is pending verification (status: ${profile.status}). Please check your email.`, true);
                    await supabaseClient.auth.signOut();
                    return;
                }

                currentUserProfile = profile;
                hideAllScreens();
                await loadBonusConfigs();

                if (currentUserProfile.role === 'admin') {
                    adminDashboard.classList.remove('hidden');
                    // FIX: Wait for the filter to be populated before triggering the data load
                    await populateSellerFilter(); 
                    document.querySelector('#admin-date-filter-buttons .filter-btn[data-filter="this-week"]')?.click();
                } else {
                    sellerDashboard.classList.remove('hidden');
                    sellerWelcomeName.textContent = `Hi, ${currentUserProfile.full_name.split(' ')[0]}!`;
                    document.querySelector('#date-filter-buttons .filter-btn[data-filter="this-week"]')?.click();
                }
            }

            async function populateSellerFilter() {
                const { data, error } = await supabaseClient
                    .from('sellers_v')      // view = sellers only
                    .select('*')            // id, full_name
                    .order('full_name');

                if (error) {
                    showNotification('Failed to load sellers.', true);
                    return;
                }
                sellerFilter.innerHTML = '<option value="all">All Sellers</option>';
                data.forEach(seller => {
                    const option = document.createElement('option');
                    option.value = seller.id;
                    option.textContent = seller.full_name || 'Unnamed Seller';
                    sellerFilter.appendChild(option);
                });
            }

            function calculateDuration() {
                const startTimeInput = document.getElementById('start-time');
                const endTimeInput = document.getElementById('end-time');
                const durationInput = document.getElementById('duration');
                if (startTimeInput.value && endTimeInput.value) {
                    const start = new Date(startTimeInput.value);
                    const end = new Date(endTimeInput.value);
                    if (end > start) {
                        let diff = (end.getTime() - start.getTime()) / 1000 / 60;
                        const hours = Math.floor(diff / 60);
                        const minutes = Math.round(diff % 60);
                        durationInput.value = `${hours}h ${minutes}m`;
                    } else {
                        durationInput.value = 'Invalid range';
                    }
                } else {
                    durationInput.value = '0h 0m';
                }
            }
            
            function formatDate(date) {
                return date.toISOString().split('T')[0];
            }
            
            function formatShortDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', timeZone: 'UTC' });
            }
            
            function formatDateTimeLocal(dateString) {
                if (!dateString) return '';
                const date = new Date(dateString);
                const timezoneOffset = date.getTimezoneOffset() * 60000;
                const localDate = new Date(date.getTime() - timezoneOffset);
                return localDate.toISOString().slice(0, 16);
            }

            function renderSkeletonLogs(targetTable, rowCount = 3) {
                targetTable.innerHTML = '';
                for (let i = 0; i < rowCount; i++) {
                    const row = targetTable.insertRow();
                    row.innerHTML = `
                        <td class="align-top">
                            <div class="h-5 w-20 mb-2 rounded skeleton"></div>
                            <div class="h-3 w-16 rounded skeleton"></div>
                        </td>
                        <td class="align-top">
                            <div class="h-4 w-24 mb-2 rounded skeleton"></div>
                            <div class="h-4 w-24 rounded skeleton"></div>
                        </td>
                        <td class="align-top">
                            <div class="h-4 w-28 mb-2 rounded skeleton"></div>
                            <div class="h-4 w-28 mb-2 rounded skeleton"></div>
                            <div class="h-5 w-32 mt-1 rounded skeleton"></div>
                        </td>
                        ${targetTable.id.includes('admin') ? '<td class="align-top"><div class="h-8 w-8 rounded-full skeleton"></div></td>' : ''}
                    `;
                }
            }

            async function renderLogs(logs, targetTable, userType = 'seller') {
                targetTable.innerHTML = '';
                if (!logs || logs.length === 0) {
                    const row = targetTable.insertRow();
                    const cell = row.insertCell();
                    cell.colSpan = userType === 'admin' ? 4 : 3;
                    cell.className = 'text-center p-4 text-gray-500';
                    cell.textContent = 'No logs found for this period.';
                    return;
                }
                
                for (const log of logs) {
                    const row = targetTable.insertRow();
                    const totalBonus = (log.payout_daily_bonus || 0) + (log.payout_weekly_bonus || 0) + (log.payout_monthly_bonus || 0);
                    const totalPayout = (log.payout_base || 0) + totalBonus;
                    
                    let actionsHtml = '';
                    if (userType === 'admin') {
                        actionsHtml = `<td class="align-top"><button class="edit-log-btn p-1 text-blue-600 hover:text-blue-800" data-log-id="${log.id}"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button></td>`;
                    }
                    
                    row.innerHTML = `
                        <td class="align-top">
                            <div class="font-bold text-gray-800">${formatShortDate(log.start_time)}</div>
                            <div class="text-xs text-gray-600">${Math.floor(log.duration_minutes / 60)}h ${log.duration_minutes % 60}m</div>
                        </td>
                        <td class="align-top">
                            <div class="text-sm"><span class="font-medium text-gray-600">Branded:</span> ${log.branded_sold}</div>
                            <div class="text-sm"><span class="font-medium text-gray-600">Free Size:</span> ${log.free_size_sold}</div>
                        </td>
                        <td class="align-top">
                            <div class="text-sm text-gray-700">Base: ₱${(log.payout_base || 0).toFixed(2)}</div>
                            <div class="text-sm text-amber-700">Bonus: ₱${totalBonus.toFixed(2)}</div>
                            <div class="font-bold text-gray-900 mt-1">Total: ₱${totalPayout.toFixed(2)}</div>
                        </td>
                        ${actionsHtml}
                    `;
                }
            }

            async function updateIndividualStatCards(userType) {
                const is_admin = userType === 'admin';
                const prefix = is_admin ? 'admin-' : '';
                const startInput = is_admin ? adminStartDateInput : startDateInput;
                const endInput = is_admin ? adminEndDateInput : endDateInput;
                const selectedSellerId = is_admin ? sellerFilter.value : currentUserProfile.id;

                if (!startInput.value || !endInput.value || !selectedSellerId) {
                    return;
                }

                try {
                    const { data, error } = await supabaseClient.functions.invoke('calculate-bonuses', {
                        body: {
                            startDate: startInput.value,
                            endDate: endInput.value,
                            sellerId: selectedSellerId
                        }
                    });

                    if (error) {
                        // Detect 404 error from Supabase function endpoint
                        if (error.status === 404 || (error.message && error.message.includes('404'))) {
                            showNotification('Bonus Error: Endpoint not found (404). Please check if the Supabase Edge Function "calculate-bonuses" is deployed.', true);
                            console.error('Supabase function endpoint not found (404): calculate-bonuses', error);
                        } else {
                            throw error;
                        }
                        // Set stat cards to Error
                        const statCardsToAnimate = [`${prefix}stat-basepay`, `${prefix}stat-daily-bonus`, `${prefix}stat-weekly-bonus`, `${prefix}stat-monthly-bonus`, `${prefix}stat-total`];
                        statCardsToAnimate.forEach(id => {
                            const el = document.getElementById(id);
                            if(el) el.textContent = 'Error';
                        });
                        return;
                    }

                    const formatCurrency = (num) => `₱${(num || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                    document.getElementById(`${prefix}stat-basepay`).textContent = formatCurrency(data.basePay);
                    document.getElementById(`${prefix}stat-daily-bonus`).textContent = formatCurrency(data.dailyBonus);
                    document.getElementById(`${prefix}stat-weekly-bonus`).textContent = formatCurrency(data.weeklyBonus);
                    document.getElementById(`${prefix}stat-monthly-bonus`).textContent = formatCurrency(data.monthlyBonus);
                    document.getElementById(`${prefix}stat-total`).textContent = formatCurrency(data.totalPayout);

                } catch (err) {
                    let errorMessage = err.message || 'An unknown error occurred.';
                    if (err.context && typeof err.context.json === 'function') {
                        try {
                            const errorBody = await err.context.json();
                            errorMessage = errorBody.message || errorBody.error || errorMessage;
                        } catch (parseError) {
                            try {
                                errorMessage = await err.context.text();
                            } catch (textError) {
                                console.error('Failed to parse error response as text:', textError);
                            }
                        }
                    }
                    console.error('Error invoking bonus calculator:', errorMessage, err);
                    showNotification(`Bonus Error: ${errorMessage}`, true);
                    const statCardsToAnimate = [`${prefix}stat-basepay`, `${prefix}stat-daily-bonus`, `${prefix}stat-weekly-bonus`, `${prefix}stat-monthly-bonus`, `${prefix}stat-total`];
                    statCardsToAnimate.forEach(id => {
                        const el = document.getElementById(id);
                        if(el) el.textContent = 'Error';
                    });
                }
            }
            
            async function updateAggregateStatCards(userType) {
                const prefix = userType === 'admin' ? 'admin-' : '';
                const startInput = userType === 'admin' ? adminStartDateInput : startDateInput;
                const endInput = userType === 'admin' ? adminEndDateInput : endDateInput;

                try {
                    const { data, error } = await supabaseClient.functions.invoke('get-aggregate-stats', {
                        body: {
                            startDate: startInput.value,
                            endDate: endInput.value,
                        }
                    });

                    if (error) {
                        let errorMessage = '';
                        if (typeof error === 'string') {
                            errorMessage = error;
                        } else if (error && (error.message || error.error)) {
                            errorMessage = error.message || error.error;
                        } else {
                            errorMessage = JSON.stringify(error);
                        }
                        throw new Error(errorMessage);
                    }

                    const formatCurrency = (num) => `₱${(num || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                    document.getElementById(`${prefix}stat-branded`).textContent = data.total_branded_sold || 0;
                    document.getElementById(`${prefix}stat-freesize`).textContent = data.total_freesize_sold || 0;
                    document.getElementById(`${prefix}stat-basepay`).textContent = formatCurrency(data.total_base_pay);
                    document.getElementById(`${prefix}stat-daily-bonus`).textContent = formatCurrency(data.total_daily_bonus);
                    document.getElementById(`${prefix}stat-weekly-bonus`).textContent = formatCurrency(data.total_weekly_bonus);
                    document.getElementById(`${prefix}stat-monthly-bonus`).textContent = formatCurrency(data.total_monthly_bonus);
                    document.getElementById(`${prefix}stat-total`).textContent = formatCurrency(data.final_total_payout);

                } catch (err) {
                    let errorMessage = err.message || 'An unknown error occurred.';
                    showNotification(`Aggregate Error: ${errorMessage}`, true);
                    console.error('Error invoking aggregate stats:', errorMessage, err);
                }
            }
            
            async function updateStatCards(userType) {
                const is_admin = userType === 'admin';
                const prefix = is_admin ? 'admin-' : '';
                const selectedSellerId = is_admin ? sellerFilter.value : currentUserProfile.id;

                const statCardsToAnimate = [
                    `${prefix}stat-basepay`, `${prefix}stat-daily-bonus`, `${prefix}stat-weekly-bonus`,
                    `${prefix}stat-monthly-bonus`, `${prefix}stat-total`
                ];
                 statCardsToAnimate.forEach(id => {
                    const el = document.getElementById(id);
                    if(el) {
                        el.parentElement.classList.add('stat-skeleton');
                        el.classList.add('stat-value');
                        el.innerHTML = '&nbsp;';
                    }
                });

                try {
                    if (is_admin && selectedSellerId === 'all') {
                        await updateAggregateStatCards(userType);
                    } else {
                        await updateIndividualStatCards(userType);
                    }
                } finally {
                     statCardsToAnimate.forEach(id => {
                        const el = document.getElementById(id);
                        if(el) {
                           el.parentElement.classList.remove('stat-skeleton');
                           el.classList.remove('stat-value');
                        }
                    });
                }
            }

            async function fetchAndRenderLogs(userType) {
                const is_admin = userType === 'admin';
                const startInput = is_admin ? adminStartDateInput : startDateInput;
                const endInput = is_admin ? adminEndDateInput : endDateInput;
                const tableBody = is_admin ? adminLogsTableBody : logsTableBody;

                renderSkeletonLogs(tableBody);

                let query = supabaseClient
                    .from('logged_sessions')
                    .select('*, seller:profiles!logged_sessions_seller_id_fkey(role)')
                    .gte('start_time', startInput.value)
                    .lte('start_time', `${endInput.value}T23:59:59Z`)
                    .order('start_time', { ascending: false });

                if (is_admin) {
                    const selectedSellerId = sellerFilter.value;
                    if (selectedSellerId !== 'all') {
                        query = query.eq('seller_id', selectedSellerId);
                    } else {
                        // Only include logs for users whose current role is 'seller'
                        query = query.eq('seller.role', 'seller');
                    }
                } else {
                    query = query.eq('seller_id', currentUserProfile.id);
                }

                const { data, error } = await query;

                if (error) {
                    showNotification('Failed to load logs.', true);
                    tableBody.innerHTML = '';
                    return;
                }
                
                await renderLogs(data, tableBody, userType);
            }
            
            async function applyFilter(userType) {
                const startInput = userType === 'admin' ? adminStartDateInput : startDateInput;
                const endInput = userType === 'admin' ? adminEndDateInput : endDateInput;
                
                if (!startInput.value || !endInput.value) return;

                await Promise.all([
                    fetchAndRenderLogs(userType),
                    updateStatCards(userType)
                ]);
            }

            function handleDateFilterClick(e, userType) {
                const clickedButton = e.target.closest('.filter-btn');
                if (!clickedButton) return;
                
                const is_admin = userType === 'admin';
                const filterButtons = is_admin ? adminDateFilterButtons : dateFilterButtons;
                const customFilter = is_admin ? adminCustomDateFilter : customDateFilter;
                const startInput = is_admin ? adminStartDateInput : startDateInput;
                const endInput = is_admin ? adminEndDateInput : endDateInput;

                filterButtons.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                clickedButton.classList.add('active');

                const filterType = clickedButton.dataset.filter;
                
                if (filterType === 'custom') {
                    customFilter.classList.remove('hidden');
                    return;
                }
                
                customFilter.classList.add('hidden');
                const today = new Date(); 
                let startDate, endDate;
                
                const dayOfWeek = today.getDay();
                const diffToWednesday = (dayOfWeek < 3) ? dayOfWeek + 4 : dayOfWeek - 3;
                
                const thisWeekStart = new Date(today);
                thisWeekStart.setDate(today.getDate() - diffToWednesday);
                thisWeekStart.setHours(0, 0, 0, 0);

                if (filterType === 'this-week') {
                    startDate = new Date(thisWeekStart);
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6);
                } else if (filterType === 'last-week') {
                    startDate = new Date(thisWeekStart);
                    startDate.setDate(thisWeekStart.getDate() - 7);
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6);
                }
                
                startInput.value = formatDate(startDate);
                endInput.value = formatDate(endDate);
                applyFilter(userType);
            }

            function handleDateInputChange(startInput, endInput, userType) {
                const startDate = startInput.value;
                const endDate = endInput.value;

                if (startDate && endDate) {
                    if (endDate < startDate) {
                        showNotification('End date cannot be earlier than start date.', true);
                        endInput.value = startDate;
                    }
                    applyFilter(userType);
                }
            }

            async function openEditLogModal(logId) {
                const { data: log, error } = await supabaseClient.from('logged_sessions').select('*, seller:seller_id (full_name)').eq('id', logId).single();
                if (error || !log) {
                    showNotification('Could not find log entry.', true);
                    return;
                }

                logModalTitle.textContent = 'Edit Log';
                logModalSellerName.textContent = `Seller: ${log.seller.full_name || 'Unknown'}`;
                logModalSellerName.classList.remove('hidden');

                document.getElementById('log-id').value = log.id;
                document.getElementById('start-time').value = formatDateTimeLocal(log.start_time);
                document.getElementById('end-time').value = formatDateTimeLocal(log.end_time);
                document.getElementById('branded-sold').value = log.branded_sold;
                document.getElementById('free-size-sold').value = log.free_size_sold;
                calculateDuration();
                logEntryModal.classList.remove('hidden');
            }
            
            async function renderUsers() {
                const { data: users, error } = await supabaseClient.from('profiles').select('*').order('full_name');
                if (error) {
                    showNotification('Could not load users.', true);
                    return;
                }
                
                userListTable.innerHTML = '';
                users.forEach(user => {
                    const row = userListTable.insertRow();
                    const statusClass = user.status === 'active' ? 'text-green-700' : 'text-red-700';
                    row.innerHTML = `
                        <td class="align-top">
                            <div class="font-bold text-gray-800">${user.full_name || 'N/A'}</div>
                            <div class="text-xs text-gray-500">${user.email}</div>
                        </td>
                        <td class="align-top text-sm capitalize text-gray-600">${user.role}</td>
                        <td class="align-top text-sm capitalize font-medium ${statusClass}">${user.status}</td>
                        <td class="align-top">
                            <div class="flex items-center gap-2">
                                <button class="edit-user-btn p-1 text-blue-600 hover:text-blue-800" data-user-id="${user.id}"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
                            </div>
                        </td>
                    `;
                });
            }
            
            async function openUserModal(userId = null) {
                userForm.reset();
                document.getElementById('user-email').disabled = false;
                resetPasswordBtn.classList.add('hidden');
                
                if (userId) {
                    const { data: user, error } = await supabaseClient.from('profiles').select('*').eq('id', userId).single();
                    if (error || !user) {
                        showNotification('Could not find user.', true);
                        return;
                    }
                    userModalTitle.textContent = 'Edit User';
                    document.getElementById('user-id').value = user.id;
                    document.getElementById('user-email').value = user.email;
                    document.getElementById('user-email').disabled = true;
                    document.getElementById('user-name').value = user.full_name;
                    document.getElementById('user-role').value = user.role;
                    document.getElementById('user-status').value = user.status;
                    resetPasswordBtn.classList.remove('hidden');
                } else {
                    userModalTitle.textContent = 'Add New User';
                }
                userModal.classList.remove('hidden');
            }
            
            async function openProfileModal() {
                if (!currentUserProfile) return;
                document.getElementById('profile-name').value = currentUserProfile.full_name;
                document.getElementById('profile-phone').value = currentUserProfile.contact_number;
                document.getElementById('profile-gcash').value = currentUserProfile.gcash_number;
                profileModal.classList.remove('hidden');
            }

            async function loadBonusConfigs() {
                const { data, error } = await supabaseClient.from('bonus_configs').select('*');
                if (error) {
                    showNotification('Could not load bonus settings.', true);
                    return;
                }
                bonusConfigs = data.reduce((acc, config) => {
                    acc[config.cadence] = config;
                    return acc;
                }, {});

                Object.keys(bonusConfigs).forEach(cadence => {
                    const config = bonusConfigs[cadence];
                    const tooltip = document.getElementById(`${cadence}-bonus-tooltip`);
                    if(tooltip) {
                        tooltip.innerHTML = `
                            Requires ${config.min_duration_hours}h, ${config.min_branded_sold} branded, and ${config.min_freesize_sold} free size items.
                            <svg class="absolute text-gray-800 h-2 w-full left-0 top-full" x="0px" y="0px" viewBox="0 0 255 255" xml:space="preserve"><polygon class="fill-current" points="0,0 127.5,127.5 255,0"/></svg>
                        `;
                    }
                });
            }

            async function populateBonusConfigForm(cadence) {
                const config = bonusConfigs[cadence];
                if (config) {
                    document.getElementById('bonus-config-id').value = config.id;
                    document.getElementById('target-duration').value = config.min_duration_hours;
                    document.getElementById('target-branded').value = config.min_branded_sold;
                    document.getElementById('target-freesize').value = config.min_freesize_sold;
                    document.getElementById('bonus-amount').value = config.bonus_amount;
                } else {
                    bonusConfigForm.reset();
                    document.getElementById('bonus-config-id').value = '';
                }
            }

            // --- Event Listeners ---
            supabaseClient.auth.onAuthStateChange(async (event, session) => {
                if (event === 'PASSWORD_RECOVERY') {
                    hideAllScreens();
                    passwordResetScreen.classList.remove('hidden');
                } else if (event === 'SIGNED_IN' || event === 'INITIAL_SESSION') {
                    await handleUserSession(session);
                } else if (event === 'SIGNED_OUT') {
                    currentUserProfile = null;
                    hideAllScreens();
                    loginScreen.classList.remove('hidden');
                }
            });
            
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const signInBtn = loginForm.querySelector('button[type="submit"]');
                signInBtn.disabled = true;
                const originalText = signInBtn.innerHTML;
                signInBtn.innerHTML = '<span class="animate-spin mr-2">⏳</span>Signing In...';
                try {
                    const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
                    if (error) showNotification(error.message, true);
                } catch (err) {
                    showNotification('Network error. Please try again.', true);
                } finally {
                    signInBtn.disabled = false;
                    signInBtn.innerHTML = originalText;
                }
            });

            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const fullName = document.getElementById('register-full-name').value;
                
                const { data, error } = await supabaseClient.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            full_name: fullName
                        }
                    }
                });

                if (error) {
                    showNotification(error.message, true);
                } else {
                    showNotification('Registration successful! Please check your email to verify your account.');
                    registerForm.reset();
                    hideAllScreens();
                    loginScreen.classList.remove('hidden');
                }
            });
            
            passwordResetForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-new-password').value;
                if(newPassword !== confirmPassword) {
                    showNotification("Passwords do not match.", true);
                    return;
                }
                const { error } = await supabaseClient.auth.updateUser({ password: newPassword });
                if (error) {
                    showNotification(error.message, true);
                } else {
                    showNotification('Password updated successfully!');
                    hideAllScreens();
                    loginScreen.classList.remove('hidden');
                }
            });

            logoutBtns.forEach(btn => btn.addEventListener('click', async () => {
                await supabaseClient.auth.signOut();
            }));

            showRegisterLink.addEventListener('click', (e) => {
                e.preventDefault();
                hideAllScreens();
                registerScreen.classList.remove('hidden');
            });

            showLoginLink.addEventListener('click', (e) => {
                e.preventDefault();
                hideAllScreens();
                loginScreen.classList.remove('hidden');
            });
            
            goToLoginBtn.addEventListener('click', (e) => {
                e.preventDefault();
                window.location.hash = ''; // Clear the hash
                hideAllScreens();
                loginScreen.classList.remove('hidden');
            });
            
            // --- Log Entry Modal Listeners ---
            openLogEntryModalBtn.addEventListener('click', () => {
                logEntryForm.reset();
                logModalTitle.textContent = 'Log Entry';
                logModalSellerName.classList.add('hidden');
                document.getElementById('log-id').value = '';
                logEntryModal.classList.remove('hidden');
            });
            
            closeLogEntryModalBtn.addEventListener('click', () => {
                logEntryModal.classList.add('hidden');
            });
            
            logEntryForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const logId = document.getElementById('log-id').value;
                const isAdmin = currentUserProfile.role === 'admin';
                
                const logData = {
                    start_time: document.getElementById('start-time').value,
                    end_time: document.getElementById('end-time').value,
                    branded_sold: parseInt(document.getElementById('branded-sold').value) || 0,
                    free_size_sold: parseInt(document.getElementById('free-size-sold').value) || 0,
                };
                
                let response;
                if (logId) {
                    response = await supabaseClient.from('logged_sessions').update(logData).eq('id', logId);
                } else {
                    logData.seller_id = currentUserProfile.id;
                    logData.created_by = currentUserProfile.id;
                    response = await supabaseClient.from('logged_sessions').insert([logData]);
                }

                if (response.error) {
                    showNotification(response.error.message, true);
                } else {
                    showNotification(`Log ${logId ? 'updated' : 'created'} successfully!`);
                    logEntryModal.classList.add('hidden');
                    applyFilter(isAdmin ? 'admin' : 'seller');
                }
            });
            
            ['start-time', 'end-time'].forEach(id => {
                document.getElementById(id).addEventListener('change', calculateDuration);
            });

            // --- Filter Listeners ---
            dateFilterButtons.addEventListener('click', (e) => handleDateFilterClick(e, 'seller'));
            adminDateFilterButtons.addEventListener('click', (e) => handleDateFilterClick(e, 'admin'));
            
            startDateInput.addEventListener('change', () => handleDateInputChange(startDateInput, endDateInput, 'seller'));
            endDateInput.addEventListener('change', () => handleDateInputChange(startDateInput, endDateInput, 'seller'));
            adminStartDateInput.addEventListener('change', () => handleDateInputChange(adminStartDateInput, adminEndDateInput, 'admin'));
            adminEndDateInput.addEventListener('change', () => handleDateInputChange(adminStartDateInput, adminEndDateInput, 'admin'));
            
            sellerFilter.addEventListener('change', () => applyFilter('admin'));
            
            // --- Admin Listeners ---
            document.getElementById('admin-logs-table').addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-log-btn');
                if (editBtn) {
                    openEditLogModal(editBtn.dataset.logId);
                }
            });

            openUserManagementBtn.addEventListener('click', () => {
                hideAllScreens();
                userManagementPage.classList.remove('hidden');
                renderUsers();
            });

            backToAdminDashBtn.addEventListener('click', () => {
                hideAllScreens();
                adminDashboard.classList.remove('hidden');
            });

            // --- Bonus Config Modal Listeners ---
            openBonusConfigModalBtn.addEventListener('click', async () => {
                await loadBonusConfigs();
                populateBonusConfigForm(bonusTypeSelect.value);
                bonusConfigModal.classList.remove('hidden');
            });
            
            closeBonusConfigModalBtn.addEventListener('click', () => {
                bonusConfigModal.classList.add('hidden');
            });

            bonusTypeSelect.addEventListener('change', () => {
                populateBonusConfigForm(bonusTypeSelect.value);
            });

            bonusConfigForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const configData = {
                    cadence: bonusTypeSelect.value,
                    min_duration_hours: document.getElementById('target-duration').value,
                    min_branded_sold: document.getElementById('target-branded').value,
                    min_freesize_sold: document.getElementById('target-freesize').value,
                    bonus_amount: document.getElementById('bonus-amount').value,
                    updated_by: currentUserProfile.id
                };

                const { error } = await supabaseClient.from('bonus_configs').upsert(configData, { onConflict: 'cadence' });
                
                if (error) {
                    showNotification(error.message, true);
                } else {
                    showNotification('Bonus configuration saved!');
                    bonusConfigModal.classList.add('hidden');
                    loadBonusConfigs();
                }
            });

            // --- User Management Listeners ---
            addNewUserBtn.addEventListener('click', () => openUserModal());
            userListTable.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-user-btn');
                if (editBtn) {
                    openUserModal(editBtn.dataset.userId);
                }
            });

            closeUserModalBtn.addEventListener('click', () => userModal.classList.add('hidden'));

            userForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const userId = document.getElementById('user-id').value;
                const userData = {
                    full_name: document.getElementById('user-name').value,
                    role: document.getElementById('user-role').value,
                    status: document.getElementById('user-status').value,
                };

                if (userId) {
                    const { error } = await supabaseClient.from('profiles').update(userData).eq('id', userId);
                    if (error) showNotification(error.message, true);
                    else showNotification('User updated successfully.');
                } else {
                    const email = document.getElementById('user-email').value;
                    const { data, error } = await supabaseClient.auth.admin.inviteUserByEmail(email, {
                        data: userData
                    });
                    if (error) showNotification(error.message, true);
                    else showNotification('Invitation sent successfully.');
                }
                userModal.classList.add('hidden');
                renderUsers();
            });
            
            resetPasswordBtn.addEventListener('click', async () => {
                const email = document.getElementById('user-email').value;
                const { error } = await supabaseClient.auth.resetPasswordForEmail(email);
                if (error) {
                    showNotification(error.message, true);
                } else {
                    showNotification('Password reset email sent.');
                }
            });

            // --- Profile Modal Listeners ---
            openProfileModalBtn.addEventListener('click', openProfileModal);
            closeProfileModalBtn.addEventListener('click', () => profileModal.classList.add('hidden'));
            
            profileForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const profileUpdates = {
                    full_name: document.getElementById('profile-name').value,
                    contact_number: document.getElementById('profile-phone').value,
                    gcash_number: document.getElementById('profile-gcash').value
                };
                const { error: profileError } = await supabaseClient.from('profiles').update(profileUpdates).eq('id', currentUserProfile.id);
                if (profileError) {
                    showNotification(profileError.message, true);
                    return;
                }
                
                const newPassword = document.getElementById('profile-new-password').value;
                const confirmPassword = document.getElementById('profile-confirm-password').value;
                if (newPassword) {
                    if (newPassword !== confirmPassword) {
                        showNotification("Passwords do not match.", true);
                        return;
                    }
                    const { error: passwordError } = await supabaseClient.auth.updateUser({ password: newPassword });
                    if (passwordError) {
                         showNotification(passwordError.message, true);
                         return;
                    }
                }
                
                showNotification('Profile saved successfully!');
                profileModal.classList.add('hidden');
                currentUserProfile = await fetchUserProfile({ id: currentUserProfile.id }); 
                sellerWelcomeName.textContent = `Hi, ${currentUserProfile.full_name.split(' ')[0]}!`;
            });

        });
    </script>
<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/service-worker.js');
        });
    }
</script>
</body>
</html>

